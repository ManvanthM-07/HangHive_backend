<!DOCTYPE html>
<html>
<head>
    <title>Group Voice Call</title>
</head>
<body>

<h2>Group Voice Call</h2>

<button onclick="createRoom()">â• Create Room</button>
<br><br>

<input id="roomInput" placeholder="Enter Room ID">
<button onclick="joinRoom()">ğŸ“ Join</button>
<button onclick="toggleMute()">ğŸ”‡ Mute</button>
<button onclick="endCall()">âŒ End</button>

<p id="status">Not Connected</p>
<p id="muteStatus">Unmuted ğŸ¤</p>

<div id="audios"></div>

<script>
let localStream;
let socket;
let roomId;
let userId = Math.random().toString(36).substring(2, 9);
let peers = {};
let isMuted = false;

async function createRoom() {
    const res = await fetch("http://127.0.0.1:8000/create-room", {
        method: "POST"
    });
    const data = await res.json();
    document.getElementById("roomInput").value = data.room_id;
    alert("Room Created: " + data.room_id);
}

async function joinRoom() {
    roomId = document.getElementById("roomInput").value;
    if (!roomId) return alert("Enter Room ID");

    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
        alert("Microphone permission denied!");
        return;
    }

    socket = new WebSocket(`ws://127.0.0.1:8000/ws/${roomId}/${userId}`);

    socket.onopen = () => {
        document.getElementById("status").innerText = "Connected";
    };

    socket.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "new-user") {
            createPeer(data.user_id, true);
        }

        if (data.type === "offer") {
            createPeer(data.sender, false, data.offer);
        }

        if (data.type === "answer") {
            await peers[data.sender].setRemoteDescription(data.answer);
        }

        if (data.type === "candidate") {
            await peers[data.sender].addIceCandidate(data.candidate);
        }

        if (data.type === "user-left") {
            if (peers[data.user_id]) {
                peers[data.user_id].close();
                delete peers[data.user_id];
            }
        }
    };
}

function createPeer(targetId, initiator, offer=null) {

    const peer = new RTCPeerConnection({
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" }
        ]
    });

    peers[targetId] = peer;

    localStream.getTracks().forEach(track => {
        peer.addTrack(track, localStream);
    });

    peer.ontrack = event => {
        let audio = document.createElement("audio");
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
        audio.controls = true;
        audio.playsInline = true;

        document.getElementById("audios").appendChild(audio);

        audio.play().catch(() => {
            console.log("Autoplay blocked. Click play.");
        });
    };

    peer.onicecandidate = event => {
        if (event.candidate) {
            socket.send(JSON.stringify({
                type: "candidate",
                target: targetId,
                sender: userId,
                candidate: event.candidate
            }));
        }
    };

    if (initiator) {
        peer.createOffer().then(offer => {
            peer.setLocalDescription(offer);
            socket.send(JSON.stringify({
                type: "offer",
                target: targetId,
                sender: userId,
                offer: offer
            }));
        });
    } else {
        peer.setRemoteDescription(offer).then(() => {
            peer.createAnswer().then(answer => {
                peer.setLocalDescription(answer);
                socket.send(JSON.stringify({
                    type: "answer",
                    target: targetId,
                    sender: userId,
                    answer: answer
                }));
            });
        });
    }
}

function toggleMute() {
    if (!localStream) return;

    isMuted = !isMuted;
    localStream.getAudioTracks()[0].enabled = !isMuted;

    document.getElementById("muteStatus").innerText =
        isMuted ? "Muted ğŸ”‡" : "Unmuted ğŸ¤";
}

function endCall() {
    for (let id in peers) {
        peers[id].close();
    }

    if (socket) socket.close();

    document.getElementById("status").innerText = "Disconnected";
}
</script>

</body>
</html>
