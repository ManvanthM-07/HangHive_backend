<!DOCTYPE html>
<html>
<head>
    <title>WebRTC 1-to-1 Video Call</title>
</head>
<body>

<h2>WebRTC 1-to-1 Video Call</h2>

<video id="localVideo" autoplay playsinline muted width="300" style="border:1px solid black;"></video>
<video id="remoteVideo" autoplay playsinline width="300" style="border:1px solid black;"></video>

<br><br>
<button id="startBtn">Start Call</button>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    const socket = io();
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn = document.getElementById("startBtn");

    let localStream;
    let peerConnection;

    const configuration = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    try {
        // Ask for camera permission
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });

        localVideo.srcObject = localStream;

        peerConnection = new RTCPeerConnection(configuration);

        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        peerConnection.ontrack = (event) => {
            remoteVideo.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit("signal", {
                    type: "candidate",
                    candidate: event.candidate
                });
            }
        };

    } catch (err) {
        alert("Camera/Microphone permission denied!");
        console.error(err);
    }

    startBtn.onclick = async () => {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        socket.emit("signal", {
            type: "offer",
            offer: offer
        });
    };

    socket.on("signal", async (data) => {

        if (data.type === "offer") {
            await peerConnection.setRemoteDescription(
                new RTCSessionDescription(data.offer)
            );

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            socket.emit("signal", {
                type: "answer",
                answer: answer
            });
        }

        if (data.type === "answer") {
            await peerConnection.setRemoteDescription(
                new RTCSessionDescription(data.answer)
            );
        }

        if (data.type === "candidate") {
            await peerConnection.addIceCandidate(
                new RTCIceCandidate(data.candidate)
            );
        }
    });

});
</script>

</body>
</html>
